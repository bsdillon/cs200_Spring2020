<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
      .red {color:red; font-weight:bold;}
      .green {color:green; font-weight:bold;}
      .transparent {pointer-events:none;}
      .flipped {-webkit-transform: scaleX(-1); transform: scaleX(-1);}
      .scared {
         animation: shakeImg 0.5s;
         animation-iteration-count: infinite;
      }
      .scared.flipped {
         -webkit-transform: scaleX(-1);
         animation: shakeImg2 0.5s;
         animation-iteration-count: infinite;
      }
      @keyframes shakeImg {
         0% { transform: translate(1px, 1px) rotate(1deg); }
         20% { transform: translate(-3px, 0px) rotate(2deg); }
         30% { transform: translate(3px, 2px) rotate(-2deg); }
         50% { transform: translate(-1px, 2px) rotate(-4deg); }
         70% { transform: translate(3px, 1px) rotate(-5deg); }
         90% { transform: translate(1px, 2px) rotate(2deg); }
         100% { transform: translate(1px, -2px) rotate(-2deg); }
      }
      @keyframes shakeImg2 {
         0% { transform: translate(1px, 1px) rotate(1deg) scaleX(-1); }
         20% { transform: translate(-3px, 0px) rotate(2deg) scaleX(-1); }
         30% { transform: translate(3px, 2px) rotate(-2deg) scaleX(-1); }
         50% { transform: translate(-1px, 2px) rotate(-4deg) scaleX(-1); }
         70% { transform: translate(3px, 1px) rotate(-5deg) scaleX(-1); }
         90% { transform: translate(1px, 2px) rotate(2deg) scaleX(-1); }
         100% { transform: translate(1px, -2px) rotate(-2deg) scaleX(-1); }
      }
    </style>
    <script src="goldfield.js"></script>
    <script src="cartesian.js"></script>
    <script>
      var isFlipped=false;
      var isScared=false;
      var goldField;
      var half = 10

      function init()
      {
        goldField = new GoldField(document.getElementById("field"),50, 2*half+1, 1);
        goldField.SetClickListener(Click);
        goldField.SetKeyListener(Key);
        ResetBoard();
      }
      
      function ResetBoard()
      {
        if(isFlipped)
        {
          flip();
        }
        goldField.Reset();
        xAxis = new XAxis()
        goldField.AddGenericLayer(xAxis);
        xAxis.SetLayerOn(true);
        goldField.Redraw();

        document.getElementById("reset").style.visibility="hidden";
        hero = goldField.AddHero();
        hero.HTMLtag.classList.toggle("transparent");

        monsters = [];
        startGame();
      }
      
      function startGame()
      {
        goldField.SetMute(true);
        while(monsters.length>0)
        {
          m = monsters.pop(0);
          m.Destroy();
        }
        goldField.SetMute(false);

        var h0 = hero.GetPosition()[0];
        var h1 = Math.floor(Math.random()*(2*half+1))
        while(h0==h1)
        {
          h1 = Math.floor(Math.random()*(2*half+1))
        }
        hero.SetPosition(h1,0);

        var count = Math.floor(Math.random()*2+2);
        var mMin = 2*half+1;
        var mMax = -1;
        for(let i=0;i<count;i++)
        {
          var m = goldField.AddMonster();
          monsters.push(m);
          var m0 = m.GetPosition()[0];

          if(m0<mMin)
          {
            mMin=m0;
          }

          if(m0>mMax)
          {
            mMax=m0;
          }
        }

        if(h1>mMin)//there is at least one monster LEFT the hero
        {
          // ---M----H---
          if(isFlipped)//the hero is facing toward it
          {
            flip();//flip the hero to ensure he is scared of that one.
          }
        }
        else if(h1<mMax)//there is at least one monster RIGHT the hero
        {
          // ---H----M---
          if(!isFlipped)//the hero is facing toward it
          {
            flip();//flip the hero to ensure he is scared of that one.
          }
        }
        //logically the here either is to the left or right of a monster.
        //there are no other options. He MUST be scared now.

        CheckHero();
      }

      function Click(event)
      {
        if(event[1]==hero.GetPosition()[1])
        {
          flip();
        }
        CheckWin();
      }

      function flip()
      {
          hero.HTMLtag.classList.toggle("flipped");
          isFlipped = !isFlipped;
      }

      function Key(event)
      {
        //37 left arrow
        //38 up arrow
        //39 right arrow
        //40 down arrow

        var deltaX = 0;
        var deltaY = 0;
        if(event[0]==37)
        {
          deltaX = -1;
        }
        else if(event[0]==38)
        {
          deltaY = -1;
        }
        else if(event[0]==39)
        {
          deltaX = 1;
        }
        else if(event[0]==40)
        {
          deltaY = 1;
        }
        else if(event[0]==32)
        {
          flip();
          CheckHero();
          CheckWin();
          return;
        }

        if(hero != null)
        {
          var dim = goldField.GetDimensions();
          var loc = hero.GetPosition();
          var originalX = loc[0];
          if(!(loc[0] + deltaX < 0 || loc[0] + deltaX == dim[0]))
          {
            loc[0] = loc[0]+deltaX;
          }

          if(!(loc[1] + deltaY < 0 || loc[1] + deltaY == dim[1]))
          {
            loc[1] = loc[1]+deltaY;
          }

          var nextSpace = goldField.LookAt(loc[0],loc[1]);
          if(nextSpace[0]==Empty)
          {
            hero.SetPosition(loc[0],loc[1]);
          }
          else if(nextSpace[1]=="Monster")
          {
            //need to switch the players
            //first move hero randomly
            var h0 = Math.floor(Math.random()*(2*half+1))
            while(goldField.LookAt(h0,0)[0]!=Empty)
            {
              h0 = Math.floor(Math.random()*(2*half+1))
            }
            hero.SetPosition(h0,0);
            m = goldField.GetMover(nextSpace[0]);
            m.SetPosition(originalX,0);
            hero.SetPosition(loc[0],loc[1]);
          }
          CheckHero();
          CheckWin();
        }
      }

      function CheckWin()
      {
        if(monsters.length>0 && !isScared)
        {
          while(monsters.length>0)
          {
            var m = monsters.pop();
            m.Destroy();
          }
          goldField.Win();
          document.getElementById("reset").style.visibility="visible";
          document.getElementById("nextLink").innerHTML = "Next Challenge >>>"
        }
      }

      function CheckHero()
      {
        var s = ""
        var scared = false;
        h0 = hero.GetPosition()[0];
        var f = isFlipped?">":"<";
        h0 -= half;
        for(let i=0;i<monsters.length;i++)
        {
          m = monsters[i].GetPosition()[0]-half;
          s+=(m>h0)? ("Hero@"+h0+" "+f+" Monster@"+m) : ("Monster@"+m+" "+f+" Hero@"+h0)
          s+=(m>h0==isFlipped)?"&nbsp;&nbsp;&nbsp;<span class='scared red'>Scary</span><br>":"&nbsp;&nbsp;&nbsp;<span class='green'>Safe</span><br>";

          if(m>h0==isFlipped)//either condition has to match the other to be scared
          {
            scared = scared || true;
          }
        }
               
        if(scared!=isScared)
        {
          hero.HTMLtag.classList.toggle("scared");
          isScared = !isScared;
        }

        document.getElementById("boundaries").innerHTML=s;

        return isScared;
      }
    </script>
  </head>
  <body onload="init()">
    <table>
      <tr>
        <td>
          <canvas id="field"></canvas>
        </td>
      </tr>
      <tr>
        <td>
          <p class="content">
             Often the computer program needs to check a boundary condition. Boundaries are described as 
             being "less than" &lt; or "greater than" &gt; some critical value. In this case we want the
             hero to create a boundary where the monsters are contained. As long as he can see all the 
             monsters he is <span class="green">SAFE</span>. If one is behind him, he will be <span class="scared red">SCARED</span>.
          </p>
          <p class="content">
             If the hero is looking left, the boudary is '&lt;' as in all the monsters are left of the
             hero. Looking to the right is '&gt;'. We can also change the X position of the hero to alter
             our boundary. See which ones show as safe or scary conditions? If the boundary is true, then
             hero is safe. You will see that scary situations are created because of incorrect logic.
          </p>
          <p id="boundaries">
          </p>
          <h1>Are you safe?</h1>
          <p class="content">
             Right now the hero is scared because some monsters are out of sight. Move him left or right 
             with the arrow keys. Use the space key or click on the hero to turn him around. Put him in 
             a position where he is safe.
          </p>
        </td>
      </tr>
    </table>
    <p id="message"></p>
    <button id="reset" onclick='ResetBoard()'>Try again</button><br>
    <a href="cartesian3.html" id="nextLink"></a>
  </body>
</html>
